
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mip_convert.save.cmor.cmor_lite &#8212; MIP Convert 2.3.3.dev0+main.2f65f7c-M documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/nature.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">MIP Convert 2.3.3.dev0+main.2f65f7c-M documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../save.html" accesskey="U">mip_convert.save</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">mip_convert.save.cmor.cmor_lite</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mip_convert.save.cmor.cmor_lite</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) British Crown Copyright 2015-2021, Met Office.</span>
<span class="c1"># Please see LICENSE.rst for license details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The :mod:`save.cmor.cmor_lite` module provides a lightweight interface</span>
<span class="sd">to |CMOR|.</span>

<span class="sd">Using |CMOR| requires three main stages. The first is to setup the</span>
<span class="sd">|CMOR| configuration options and define the |dataset| meta-data. This</span>
<span class="sd">first stage needs doing only once. The second is to define which</span>
<span class="sd">|MIP requested variables| are going to be written to this |dataset|.</span>
<span class="sd">The final stage is to actually write the data.</span>

<span class="sd">This is demonstrated with an example::</span>

<span class="sd">  from cmor_lite import setup_and_dataset, get_saver</span>

<span class="sd">  # define the dataset for the variables</span>
<span class="sd">  setup_and_dataset(conf, meta_data)</span>

<span class="sd">  # define the MIP requested variables to be written into this</span>
<span class="sd">  # dataset</span>
<span class="sd">  for variable in variables:</span>
<span class="sd">      variable.saver = get_saver(variable.mip_table_id,</span>
<span class="sd">                                 variable.variable_name)</span>

<span class="sd">  # example of writing the data</span>
<span class="sd">  for time_period in periods(start_time, end_time, period_length):</span>
<span class="sd">      for variable in variables:</span>
<span class="sd">           variable.saver(variable.data[time_period])</span>

<span class="sd">For more details see the individual function documentation in the</span>
<span class="sd">`CMOR Documentation`_.</span>

<span class="sd">Note: it is possible to call :func:`dataset` more than once for each</span>
<span class="sd">call to ``cmor.setup``, in practice this tends not to be done as a</span>
<span class="sd">single :func:`dataset` call gives a big enough &#39;block of work&#39; to</span>
<span class="sd">manage.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">mip_convert.save.cmor.cmor_wrapper</span> <span class="kn">import</span> <span class="n">CmorWrapper</span>
<span class="kn">from</span> <span class="nn">mip_convert.save.cmor.cmor_outputter</span> <span class="kn">import</span> <span class="n">saverFactory</span><span class="p">,</span> <span class="n">CmorOutputError</span>
<span class="kn">from</span> <span class="nn">mip_convert</span> <span class="kn">import</span> <span class="n">model_date</span>

<span class="n">_CMOR</span> <span class="o">=</span> <span class="n">CmorWrapper</span><span class="p">()</span>
<span class="n">_FACTORY</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="setup"><a class="viewcode-back" href="../../../../mip_convert/save/cmor_lite.html#mip_convert.save.cmor.cmor_lite.setup">[docs]</a><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">setup_conf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call ``cmor.setup`` with arguments from setup_conf.</span>

<span class="sd">    :param setup_conf: an object with attributes that contain the</span>
<span class="sd">                       options for the call to ``cmor.setup``.</span>

<span class="sd">    The ``setup_conf`` can have any of the attributes that are needed</span>
<span class="sd">    as options for the ``cmor.setup`` call. In this implementation, and</span>
<span class="sd">    unlike the underlying ``cmor.setup``, ``setup_conf`` must have an</span>
<span class="sd">    attribute ``inpath``.</span>

<span class="sd">    All other attributes are optional. If an attribute is missing then</span>
<span class="sd">    the corresponding function argument will be absent when</span>
<span class="sd">    ``cmor.setup`` is called. The optional attributes are:</span>
<span class="sd">    ``netcdf_file_action``, ``set_verbosity``, ``exit_control``,</span>
<span class="sd">    ``logfile`` and ``create_subdirectories``. The last three of these</span>
<span class="sd">    can be given as the named |CMOR| constants, for example</span>
<span class="sd">    ``CMOR_REPLACE``.</span>

<span class="sd">    An example implementation of a ``setup_conf`` is given in the class</span>
<span class="sd">    :class:`mip_convert.save.cmor.config_file.CmorSetupConf`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_FACTORY</span>   <span class="c1"># simplifies user interface to module</span>

    <span class="n">CmorSetupCall</span><span class="p">(</span><span class="n">_CMOR</span><span class="p">)(</span><span class="n">setup_conf</span><span class="p">)</span>
    <span class="n">_FACTORY</span> <span class="o">=</span> <span class="n">saverFactory</span><span class="p">(</span><span class="n">setup_conf</span><span class="o">.</span><span class="n">inpath</span><span class="p">,</span> <span class="n">_CMOR</span><span class="p">)</span></div>


<div class="viewcode-block" id="dataset"><a class="viewcode-back" href="../../../../mip_convert/save/cmor_lite.html#mip_convert.save.cmor.cmor_lite.dataset">[docs]</a><span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="n">meta_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call ``cmor.dataset`` with arguments taken from ``meta_data``</span>
<span class="sd">    attributes.</span>

<span class="sd">    :param meta_data: an object with attributes that contain the</span>
<span class="sd">                      options for the call to ``cmor.dataset``.</span>

<span class="sd">    The ``meta_data`` object has some compulsory attributes, and some</span>
<span class="sd">    optional attributes. These attributes are used in calls to</span>
<span class="sd">    ``cmor.dataset``. It should also have a ``global_attributes``</span>
<span class="sd">    method that returns key, value pairs of global attribute names and</span>
<span class="sd">    their values.</span>

<span class="sd">    The compulsory attributes are: ``experiment_id``, ``institution``,</span>
<span class="sd">    ``source``, ``calendar``, ``outpath`` and ``history`` (note</span>
<span class="sd">    ``outpath`` and ``history`` are compulsory even though they are</span>
<span class="sd">    optional in the underlying ``cmor.dataset`` call. The optional</span>
<span class="sd">    arguments are, largely, the remainder of the ``cmor.dataset``</span>
<span class="sd">    arguments: ``realization``, ``contact``, ``comment``,</span>
<span class="sd">    ``references``, ``leap_year``, ``leap_month``, ``month_lengths``,</span>
<span class="sd">    ``model_id``, ``forcing``, ``initialization_method``,</span>
<span class="sd">    ``physics_version``, ``institute_id``, ``parent_experiment_id``,</span>
<span class="sd">    ``branch_time``, ``parent_experiment_rip``</span>

<span class="sd">    Rather than passing in the ``cmor.dataset`` ``branch_time``, the</span>
<span class="sd">    ``meta_data`` can have a ``branch_date``, ``parent_base_date``, and</span>
<span class="sd">    ``TIME_FORMAT`` attributes. If ``branch_date`` is not present then the</span>
<span class="sd">    ``branch_time`` is set appropriately. If ``branch_date`` is</span>
<span class="sd">    present, then ``parent_base_date`` should also be present. These</span>
<span class="sd">    are then used (along with ``calendar``) to calculate the</span>
<span class="sd">    ``branch_time``. When present, ``branch_date`` and</span>
<span class="sd">    ``parent_base_date`` are strings of the format defined by</span>
<span class="sd">    ``TIME_FORMAT`` which should be a format string as described in</span>
<span class="sd">    :func:`time.strftime`.</span>

<span class="sd">    Note although an attribute of ``meta_data`` may be an optional</span>
<span class="sd">    argument to ``cmor.dataset`` the |MIP tables| may insist on some</span>
<span class="sd">    options being present.</span>

<span class="sd">    An example implementation of a ``meta_data`` class can be found in</span>
<span class="sd">    :class:`mip_convert.save.cmor.config_file.CmorDatasetConf`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CmorDatasetCall</span><span class="p">(</span><span class="n">_CMOR</span><span class="p">)(</span><span class="n">meta_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="setup_and_dataset"><a class="viewcode-back" href="../../../../mip_convert/save/cmor_lite.html#mip_convert.save.cmor.cmor_lite.setup_and_dataset">[docs]</a><span class="k">def</span> <span class="nf">setup_and_dataset</span><span class="p">(</span><span class="n">setup_conf</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialise |CMOR|: both the setup configuration and the |dataset|</span>
<span class="sd">    meta-data.</span>

<span class="sd">    :param setup_conf: the |CMOR| setup configuration options</span>
<span class="sd">    :param meta_data: the meta-data for the |dataset| to be written to</span>

<span class="sd">    See the documentation for :func:`setup` and :func:`dataset` for</span>
<span class="sd">    more information on the ``setup_conf`` and ``meta_data`` arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">setup</span><span class="p">(</span><span class="n">setup_conf</span><span class="p">)</span>
    <span class="n">dataset</span><span class="p">(</span><span class="n">meta_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_saver"><a class="viewcode-back" href="../../../../mip_convert/save/cmor_lite.html#mip_convert.save.cmor.cmor_lite.get_saver">[docs]</a><span class="k">def</span> <span class="nf">get_saver</span><span class="p">(</span><span class="n">mip_table_id</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">outputs_per_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a saver callable for this ``variable_name`` from the</span>
<span class="sd">    ``mip_table_id``.</span>

<span class="sd">    The returned callable when called with a |MIP requested variable|</span>
<span class="sd">    (data and meta-data) will write that |MIP requested variable| using</span>
<span class="sd">    |CMOR|.</span>

<span class="sd">    :param mip_table_id: the |MIP table identifier|</span>
<span class="sd">    :type mip_table_id: string</span>
<span class="sd">    :param variable_name: the |MIP requested variable name|</span>
<span class="sd">    :type variable_name: string</span>
<span class="sd">    :param outputs_per_file: the number of time slices of a variable to</span>
<span class="sd">                             write to each |output netCDF file|</span>
<span class="sd">    :type outputs_per_file: int</span>
<span class="sd">    :return: a function with signature function(data)</span>
<span class="sd">    :rtype: callable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_FACTORY</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CmorOutputError</span><span class="p">(</span><span class="s1">&#39;setup_and_dataset should be called before get_saver&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_FACTORY</span><span class="o">.</span><span class="n">getSaver</span><span class="p">(</span><span class="n">mip_table_id</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">outputs_per_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="close"><a class="viewcode-back" href="../../../../mip_convert/save/cmor_lite.html#mip_convert.save.cmor.cmor_lite.close">[docs]</a><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">variable_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call |CMOR| to close down all files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_CMOR</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">variable_id</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_KeywordsFromAttributes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base class for classes that need to retrieve attributes from</span>
<span class="sd">    objects and perform some translation on the attribute.</span>

<span class="sd">    Sub classes need to define sequences _STR_ATTS, _INT_ATTS and</span>
<span class="sd">    _CMOR_CONSTANT_ATTS that contain the names of attributes that are</span>
<span class="sd">    strings, integers and |CMOR| module constants, respectively.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmor</span> <span class="o">=</span> <span class="n">cmor</span>    <span class="c1"># anomoly - longer term use _CMOR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ATTS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_STR_ATTS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_INT_ATTS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_CMOR_CONSTANT_ATTS</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_optionals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary where the keys are the conf attributes</span>
<span class="sd">        and the values are the attribute values converted to the</span>
<span class="sd">        correct type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ATTS</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">attname</span><span class="p">):</span>
                <span class="n">trans_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translator</span><span class="p">(</span><span class="n">attname</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">attname</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans_func</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">attname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">_str_to_cmor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of the |CMOR| constant for attval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self._cmor.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_translator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translate the attribute into form for ``cmor.setup``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="k">if</span> <span class="n">attname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_INT_ATTS</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span>
        <span class="k">elif</span> <span class="n">attname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CMOR_CONSTANT_ATTS</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_to_cmor</span>
        <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="CmorSetupCall"><a class="viewcode-back" href="../../../../mip_convert/save/cmor_lite.html#mip_convert.save.cmor.cmor_lite.CmorSetupCall">[docs]</a><span class="k">class</span> <span class="nc">CmorSetupCall</span><span class="p">(</span><span class="n">_KeywordsFromAttributes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See the documentation for :func:`setup`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_STR_ATTS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;inpath&#39;</span><span class="p">,</span> <span class="s1">&#39;logfile&#39;</span><span class="p">)</span>
    <span class="n">_INT_ATTS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;create_subdirectories&#39;</span><span class="p">,)</span>
    <span class="n">_CMOR_CONSTANT_ATTS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;netcdf_file_action&#39;</span><span class="p">,</span> <span class="s1">&#39;set_verbosity&#39;</span><span class="p">,</span> <span class="s1">&#39;exit_control&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_conf</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_optionals</span><span class="p">(</span><span class="n">setup_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmor</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmorDatasetCall"><a class="viewcode-back" href="../../../../mip_convert/save/cmor_lite.html#mip_convert.save.cmor.cmor_lite.CmorDatasetCall">[docs]</a><span class="k">class</span> <span class="nc">CmorDatasetCall</span><span class="p">(</span><span class="n">_KeywordsFromAttributes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See the documentation for :func:`dataset`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_STR_ATTS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;institute_id&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;contact&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;references&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;comment&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;forcing&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;parent_experiment_id&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;parent_experiment_rip&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attributes that are optional in the configuration file and are passed to ``cmor.dataset``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_INT_ATTS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;realization&#39;</span><span class="p">,</span> <span class="s1">&#39;physics_version&#39;</span><span class="p">,</span> <span class="s1">&#39;initialization_method&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integer attributes that are optional in the configuration file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_CMOR_CONSTANT_ATTS</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">_BRANCH_DATE_NOT_APPLICABLE</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The section option value indicating the fact that ``branch_date`` is not applicable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_BRANCH_TIME_NOT_APPLICABLE</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ``cmor.dataset`` argument indicating a null ``branch_time``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;write_json&#39;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">write_json</span><span class="p">()</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span>  <span class="c1"># For logging purposes only.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cmor</span><span class="o">.</span><span class="n">dataset_json</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optionals</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cmor</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                               <span class="n">config</span><span class="o">.</span><span class="n">institution</span><span class="p">,</span>
                               <span class="n">config</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                               <span class="n">config</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span>
                               <span class="n">outpath</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">outpath</span><span class="p">,</span>
                               <span class="n">history</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_optionals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_optionals</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;branch_date&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_branch_date</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">_time_from_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_date</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">option</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">TIME_FORMAT</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_branch_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deal with branch date if present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">branch_date</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BRANCH_DATE_NOT_APPLICABLE</span> <span class="ow">or</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">branch_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">branch_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BRANCH_TIME_NOT_APPLICABLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">branch_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_from_option</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;branch_date&#39;</span><span class="p">)</span>
            <span class="n">parent_base_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_from_option</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;parent_base_date&#39;</span><span class="p">)</span>
            <span class="n">branch_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">branch_date</span> <span class="o">-</span> <span class="n">parent_base_date</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;branch_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch_time</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">MIP Convert 2.3.3.dev0+main.2f65f7c-M documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../save.html" >mip_convert.save</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">mip_convert.save.cmor.cmor_lite</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright British Crown 2015-2021, Met Office.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>