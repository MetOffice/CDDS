
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mip_convert.new_variable &#8212; MIP Convert 2.3.3.dev0+main.2f65f7c-M documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MIP Convert 2.3.3.dev0+main.2f65f7c-M documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">mip_convert.new_variable</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mip_convert.new_variable</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) British Crown Copyright 2015-2022, Met Office.</span>
<span class="c1"># Please see LICENSE.rst for license details.</span>
<span class="c1"># pylint: disable=no-member, eval-used, wildcard-import</span>
<span class="c1"># pylint: disable=unused-wildcard-import</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The :mod:`new_variable` module contains the class that represents a</span>
<span class="sd">|multi-dimensional data object|.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">regex</span> <span class="k">as</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">cf_units</span>
<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">from</span> <span class="nn">iris.time</span> <span class="kn">import</span> <span class="n">PartialDateTime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">iris.util</span> <span class="kn">import</span> <span class="n">guess_coord_axis</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">mip_convert.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DEFAULT_FILL_VALUE</span><span class="p">,</span> <span class="n">Longitudes</span><span class="p">,</span> <span class="n">validate_latitudes</span><span class="p">,</span> <span class="n">format_date</span><span class="p">,</span>
    <span class="n">MIP_to_model_axis_name_mapping</span><span class="p">,</span> <span class="n">apply_time_constraint</span><span class="p">,</span> <span class="n">raw_to_value</span><span class="p">,</span>
    <span class="n">parse_to_loadables</span><span class="p">,</span> <span class="n">eorca_resolution_to_mask_slice</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mip_convert.process.config</span> <span class="kn">import</span> <span class="n">mappings_config</span>
<span class="kn">from</span> <span class="nn">mip_convert.process.constants</span> <span class="kn">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">other_constants</span>
<span class="kn">from</span> <span class="nn">mip_convert.process.processors</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mip_convert.constants</span> <span class="kn">import</span> <span class="n">TIMESTEP</span><span class="p">,</span> <span class="n">PREDEFINED_BOUNDS</span><span class="p">,</span> <span class="n">OVERRIDE_AXIS_DIRECTION</span>
<span class="kn">from</span> <span class="nn">mip_convert.variable</span> <span class="kn">import</span> <span class="n">make_masked</span>


<div class="viewcode-block" id="VariableMetadata"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableMetadata">[docs]</a><span class="k">class</span> <span class="nc">VariableMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store metadata related to a |MIP requested variable|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="VariableMetadata.__init__"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableMetadata.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">stream_id</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">mip_table_name</span><span class="p">,</span> <span class="n">mip_metadata</span><span class="p">,</span> <span class="n">site_information</span><span class="p">,</span>
                 <span class="n">hybrid_height_information</span><span class="p">,</span> <span class="n">replacement_coordinates</span><span class="p">,</span> <span class="n">model_to_mip_mapping</span><span class="p">,</span> <span class="n">timestep</span><span class="p">,</span> <span class="n">run_bounds</span><span class="p">,</span>
                 <span class="n">calendar</span><span class="p">,</span> <span class="n">base_date</span><span class="p">,</span> <span class="n">deflate_level</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">reference_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        variable_name: string</span>
<span class="sd">            The |MIP requested variable name|.</span>
<span class="sd">        stream_id: string</span>
<span class="sd">            The |stream identifier|.</span>
<span class="sd">        substream: string</span>
<span class="sd">            The substream identifier.</span>
<span class="sd">        mip_table_name: string</span>
<span class="sd">            The name of the |MIP table|.</span>
<span class="sd">        mip_metadata: :class:`VariableMIPMetadata`</span>
<span class="sd">            The values from the |MIP table| related to the</span>
<span class="sd">            |MIP requested variable|.</span>
<span class="sd">        site_information: :class:`SitesConfig`</span>
<span class="sd">            Information related to the sites.</span>
<span class="sd">        hybrid_height_information: list of :class:`HybridHeightConfig`</span>
<span class="sd">            Information related to the hybrid heights.</span>
<span class="sd">        replacement_coordinates: :class:`iris.cube.CubeList`</span>
<span class="sd">            The replacement coordinates.</span>
<span class="sd">        model_to_mip_mapping: :class:`VariableModelToMIPMapping`</span>
<span class="sd">            The |model to MIP mapping|.</span>
<span class="sd">        timestep: int</span>
<span class="sd">            The model timestep (in integer seconds).</span>
<span class="sd">        run_bounds: list of strings</span>
<span class="sd">            The &#39;run bounds&#39;.</span>
<span class="sd">        calendar: string</span>
<span class="sd">            The calendar.</span>
<span class="sd">        base_date: string</span>
<span class="sd">            The date at the start of the run.</span>
<span class="sd">        deflate_level: int</span>
<span class="sd">            The deflatation level from 0 (no compression) to 9 (maximum</span>
<span class="sd">            compression).</span>
<span class="sd">        shuffle: bool</span>
<span class="sd">            Whether to shuffle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span> <span class="o">=</span> <span class="n">variable_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_id</span> <span class="o">=</span> <span class="n">stream_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mip_table_name</span> <span class="o">=</span> <span class="n">mip_table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mip_metadata</span> <span class="o">=</span> <span class="n">mip_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_information</span> <span class="o">=</span> <span class="n">site_information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_height_information</span> <span class="o">=</span> <span class="n">hybrid_height_information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacement_coordinates</span> <span class="o">=</span> <span class="n">replacement_coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span> <span class="o">=</span> <span class="n">model_to_mip_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_bounds</span> <span class="o">=</span> <span class="n">run_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="n">calendar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_date</span> <span class="o">=</span> <span class="n">base_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deflate_level</span> <span class="o">=</span> <span class="n">deflate_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_time</span> <span class="o">=</span> <span class="n">reference_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_timestep</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_validate_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">TIMESTEP</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">expression</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;The model to MIP mapping expression contains the model timestep but no value was defined&#39;</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="Variable"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.Variable">[docs]</a><span class="k">class</span> <span class="nc">Variable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store metadata and data related to a |MIP requested variable|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Variable.__init__"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.Variable.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_variables</span><span class="p">,</span> <span class="n">variable_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_variables: dictionary</span>
<span class="sd">            The |input variables| required to produce the</span>
<span class="sd">            |MIP requested variable| in the form</span>
<span class="sd">            ``{input_variable_name: cube}``.</span>
<span class="sd">        variable_metadata: :class:`VariableMetadata`</span>
<span class="sd">            Information related to the |MIP requested variable|.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        variable_name: string</span>
<span class="sd">            The |MIP requested variable name|.</span>
<span class="sd">        mip_metadata: :class:`VariableMIPMetadata`</span>
<span class="sd">            The values from the |MIP table| related to the</span>
<span class="sd">            |MIP requested variable|.</span>
<span class="sd">        model_to_mip_mapping: :class:`VariableModelToMIPMapping`</span>
<span class="sd">            The |model to MIP mapping|.</span>
<span class="sd">        cube: :class:`iris.cube.Cube`</span>
<span class="sd">            The |MIP output variable|; this attribute is only populated</span>
<span class="sd">            after the :meth:`process` method has been executed.</span>
<span class="sd">        units: string</span>
<span class="sd">            The units of the data of the |MIP output variable| i.e.,</span>
<span class="sd">            after the :meth:`process` method has been executed.</span>
<span class="sd">        positive: string</span>
<span class="sd">            The direction of a vertical energy (heat) flux or surface</span>
<span class="sd">            momentum flux (stress) input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span> <span class="o">=</span> <span class="n">input_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span> <span class="o">=</span> <span class="n">variable_metadata</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">variable_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mip_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">mip_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">model_to_mip_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">positive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deflate_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">deflate_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">shuffle</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">stream_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_substream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">substream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mip_table_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">mip_table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">run_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">calendar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">base_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mip_axes_directions_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mip_metadata</span><span class="o">.</span><span class="n">axes_directions_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis_name_mapping</span> <span class="o">=</span> <span class="n">MIP_to_model_axis_name_mapping</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordered_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">reference_time</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return useful information about a specific instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variable_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    MIP requested variable name: </span><span class="si">{variable_name}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Stream identifier: </span><span class="si">{stream_id}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    MIP table name: </span><span class="si">{mip_table_name}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    MIP axes directions and names: </span><span class="si">{mip_axes_directions_names}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Model to MIP mapping: </span><span class="si">{model_to_mip_mapping}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Units: </span><span class="si">{units}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">variable_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span><span class="p">,</span>
                <span class="n">stream_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_id</span><span class="p">,</span>
                <span class="n">mip_table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mip_table_name</span><span class="p">,</span>
                <span class="n">mip_axes_directions_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mip_axes_directions_names</span><span class="p">,</span>
                <span class="n">model_to_mip_mapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">variable_info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return messages describing what has happened to the data in</span>
<span class="sd">        this instance.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        Create a :class:`Variable` object and update the</span>
<span class="sd">        :meth:`history` multiple times:</span>

<span class="sd">        &gt;&gt;&gt; input_variables = {}</span>
<span class="sd">        &gt;&gt;&gt; variable_model_to_mip_mapping = VariableModelToMIPMapping(</span>
<span class="sd">        ...     &#39;tas&#39;, {&#39;expression&#39;: &#39;m01s03i236&#39;, &#39;positive&#39;: None,</span>
<span class="sd">        ...     &#39;units&#39;: &#39;K&#39;}, &#39;HadGEM3-GC31-LL&#39;)</span>
<span class="sd">        &gt;&gt;&gt; variable_mip_metadata = VariableMIPMetadata(</span>
<span class="sd">        ...     {&#39;dimensions&#39;: &#39;longitude latitude time&#39;,</span>
<span class="sd">        ...      &#39;out_name&#39;: &#39;tas&#39;},</span>
<span class="sd">        ...     {&#39;longitude&#39;: {&#39;axis&#39;: &#39;Y&#39;, &#39;out_name&#39;: &#39;lon&#39;},</span>
<span class="sd">        ...      &#39;latitude&#39;: {&#39;axis&#39;: &#39;X&#39;, &#39;out_name&#39;: &#39;lat&#39;},</span>
<span class="sd">        ...      &#39;time&#39;: {&#39;axis&#39;: &#39;T&#39;, &#39;out_name&#39;: &#39;time&#39;}})</span>
<span class="sd">        &gt;&gt;&gt; variable_metadata = VariableMetadata(</span>
<span class="sd">        ...     &#39;tas&#39;, &#39;apa&#39;, None, &#39;CMIP5_day&#39;, variable_mip_metadata,</span>
<span class="sd">        ...     None, None, None, variable_model_to_mip_mapping, None,</span>
<span class="sd">        ...     [&#39;1981-09-01-00-00-00&#39;, &#39;1981-09-11-00-00-00&#39;],</span>
<span class="sd">        ...     &#39;360_day&#39;, &#39;1970-01-01-00-00-00&#39;, 9, False)</span>
<span class="sd">        &gt;&gt;&gt; variable = Variable(input_variables, variable_metadata)</span>
<span class="sd">        &gt;&gt;&gt; variable.history = &#39;Made a change.&#39;</span>
<span class="sd">        &gt;&gt;&gt; print(variable.history)</span>
<span class="sd">        Made a change.</span>
<span class="sd">        &gt;&gt;&gt; variable.history = &#39;Made another change.&#39;</span>
<span class="sd">        &gt;&gt;&gt; print(variable.history)</span>
<span class="sd">        Made a change.</span>
<span class="sd">        Made another change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span>

    <span class="nd">@history</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the history with a message describing what has happened</span>
<span class="sd">        to the data in this instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="n">message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{history}</span><span class="se">\n</span><span class="si">{message}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="Variable.slices_over"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.Variable.slices_over">[docs]</a>    <span class="k">def</span> <span class="nf">slices_over</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an iterator of :class:`new_variable.Variable` instances</span>
<span class="sd">        that contain a years worth of data.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        : :class:`new_variable.Variable`</span>
<span class="sd">            The metadata and data related to a |MIP requested variable|</span>
<span class="sd">            for a year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="s1">&#39;year&#39;</span>
        <span class="n">date_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_times_for_slices_over</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">date_time</span> <span class="ow">in</span> <span class="n">date_times</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Slice the &#39;input variable(s)&#39;, since they have not yet been processed.</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">date_time</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating data for &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="n">sliced_input_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slice_input_variables</span><span class="p">(</span><span class="n">date_time</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">Variable</span><span class="p">(</span><span class="n">sliced_input_variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Slice the &#39;MIP output variable&#39;.</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Slicing MIP output variable not yet implemented&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variable.date_times_for_slices_over"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.Variable.date_times_for_slices_over">[docs]</a>    <span class="k">def</span> <span class="nf">date_times_for_slices_over</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the date time items specifiying the period for each</span>
<span class="sd">        slice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        period: string</span>
<span class="sd">            The period that will be used to create each</span>
<span class="sd">            :class:`new_variable.Variable` instance. Currently, only</span>
<span class="sd">            ``year`` is supported.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        : a list containing lists of integers</span>
<span class="sd">            The date time items that will be used to create each</span>
<span class="sd">            :class:`new_variable.Variable` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">date_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
            <span class="n">end_month_day</span> <span class="o">=</span> <span class="n">format_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">end_year</span> <span class="o">=</span> <span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">start_year</span> <span class="o">=</span> <span class="n">start_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">end_month_day</span> <span class="o">==</span> <span class="s1">&#39;0101&#39;</span><span class="p">:</span>
                <span class="n">end_year</span> <span class="o">=</span> <span class="n">end_year</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">date_times</span> <span class="o">=</span> <span class="p">[[</span><span class="n">year</span><span class="p">]</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_year</span><span class="p">,</span> <span class="n">end_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">date_times</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ordered_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the coordinates in the cube that correspond with the</span>
<span class="sd">        axes in the |MIP table| in the order that matches the data in</span>
<span class="sd">        the cube, in the form ``[(coord, axis_direction, axis_name)]``,</span>
<span class="sd">        where ``coord`` is the coordinate in the cube,</span>
<span class="sd">        ``axis_direction`` is the axis direction of the coordinate in</span>
<span class="sd">        the cube and ``axis_name`` is the name of the axis in the</span>
<span class="sd">        |MIP table|.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordered_coords</span><span class="p">:</span>
            <span class="c1"># Match the coordinates in the cube with the dimensions in the &#39;MIP table&#39; (sets &#39;self._matched_coords&#39;).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_match_cube_coords_with_mip_axes</span><span class="p">()</span>

            <span class="c1"># Promote any scalar coordinates.</span>
            <span class="n">update_matched_coords</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span><span class="p">:</span>
                <span class="n">data_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dimension</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data_dimension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">update_matched_coords</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">new_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">update_matched_coords</span><span class="p">:</span>
                <span class="c1"># The reference to the coordinates in the cube provided by &#39;self._matched_coords&#39; is lost after running</span>
                <span class="c1"># &#39;iris.util.new_axis&#39;; regenerate the list.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_match_cube_coords_with_mip_axes</span><span class="p">()</span>

            <span class="c1"># Use the data_dimension to determine the order of the coordinates.</span>
            <span class="n">data_dimensions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dimension</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">),</span> <span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_dimensions</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ordered_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">))</span>

            <span class="n">ordered_for_log</span> <span class="o">=</span> <span class="p">[(</span><span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordered_coords</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Order of axes: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ordered_for_log</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordered_coords</span>

<div class="viewcode-block" id="Variable.process"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.Variable.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the data.</span>

<span class="sd">        The units of the data of the |MIP requested variable| are the</span>
<span class="sd">        units of the data after the expression from the</span>
<span class="sd">        |model to MIP mapping| has been applied. For</span>
<span class="sd">        |model to MIP mapping| expressions that contain a single</span>
<span class="sd">        constraint, the units of the data in the cube are used. For</span>
<span class="sd">        |model to MIP mapping| expressions that contain more than</span>
<span class="sd">        one constraint, the units of the data must be provided by the</span>
<span class="sd">        |model to MIP mappings|.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No input variables to process&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing the data ...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_units_from_input_variables_as_necessary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_masked_arrays</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardise</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_expression</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_cube</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_coord</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_time_units</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="p">,</span> <span class="s1">&#39;valid_min&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_valid_min_correction</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_remove_units_from_input_variables_as_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># To prevent the Iris error &quot;Cannot use &lt;operator&gt; with</span>
        <span class="c1"># differing units&quot; when applying expressions containing</span>
        <span class="c1"># multiple &#39;input variables&#39;, remove the units from the</span>
        <span class="c1"># &#39;input variables&#39; prior to applying the expression.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cube</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">cube</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_masked_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This method realises the data.</span>
        <span class="k">for</span> <span class="n">cube</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s1">&#39;fill_value&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>  <span class="c1"># Iris v1</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;fill_value&#39;</span><span class="p">):</span>  <span class="c1"># Iris v2</span>
                    <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;fill_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;fill_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_FILL_VALUE</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMaskedArray</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
                <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">make_masked</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;fill_value&#39;</span><span class="p">],</span> <span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_standardise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">model_id</span>

        <span class="k">for</span> <span class="n">cube</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">model_component</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;model_component&#39;</span><span class="p">]</span>

            <span class="c1"># If CICE data modify the mode_component value to include grid information.</span>
            <span class="k">if</span> <span class="n">model_component</span> <span class="o">==</span> <span class="s1">&#39;cice&#39;</span><span class="p">:</span>
                <span class="c1"># cice_grid will be either &quot;T&quot; or &quot;V&quot; if variable has &quot;TLAT&quot; or &quot;ULAT&quot; respectively in its</span>
                <span class="c1"># &quot;coordinates&quot; netcdf attribute.</span>
                <span class="n">cice_grid</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">var_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">model_component</span> <span class="o">=</span> <span class="s1">&#39;cice-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cice_grid</span><span class="p">)</span>

            <span class="n">orca_slice</span> <span class="o">=</span> <span class="n">eorca_resolution_to_mask_slice</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">model_component</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substream</span><span class="p">)</span>
            <span class="n">cube_coord_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">()}</span>
            <span class="k">if</span> <span class="p">{</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">}</span> <span class="o">&lt;=</span> <span class="n">cube_coord_names</span> <span class="ow">and</span> <span class="n">orca_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># update the existing mask</span>
                <span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">orca_slice</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

    <span class="k">def</span> <span class="nf">_apply_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Persist the fill_value attribute from the &#39;input variables&#39; to the &#39;output variable&#39;.</span>
        <span class="n">fill_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fill_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;fill_value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cube</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="s1">&#39;fill_value&#39;</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">fill_values</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fill_values</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fill_value</span> <span class="o">=</span> <span class="n">fill_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">expression_with_constraints</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">TIMESTEP</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestep</span><span class="p">))</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">_update_constraints_in_expression</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">expression</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Evaluating expression &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expression</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;fill_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{cube}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_units</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_coord_points</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_coord_bounds</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">reference_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">remove_coord</span><span class="p">(</span><span class="s2">&quot;forecast_period&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">==</span> <span class="s1">&#39;forecast_reference_time&#39;</span><span class="p">:</span>
                    <span class="c1"># this is populated from mip_convert config file</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">reference_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                    <span class="n">reftime_units</span> <span class="o">=</span> <span class="s1">&#39;days since </span><span class="si">{}</span><span class="s1">-</span><span class="si">{:02d}</span><span class="s1">-</span><span class="si">{:02d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">base_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)])</span>
                    <span class="n">reftime_calendar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">calendar</span>
                    <span class="c1"># not sure why including the time {:02d}:{:02d}:{:02d} upsets CMOR in the above, but it does</span>
                    <span class="n">coord</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">cf_units</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">dt</span><span class="p">),</span> <span class="n">reftime_units</span><span class="p">,</span> <span class="n">reftime_calendar</span><span class="p">)]</span>
                    <span class="n">coord</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">reftime_units</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="n">reftime_calendar</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;T-reftime&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mip_axes_directions_names</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_metadata</span><span class="o">.</span><span class="n">reference_time</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Parameter &quot;reference_time&quot; not set in request section of config file, &#39;</span>
                               <span class="s1">&#39;but it is needed for this variable&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The units of the &#39;MIP requested variable&#39; must always be the units from the &#39;model to MIP mapping&#39;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">units</span>

        <span class="c1"># Update the units on the cube, if necessary.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_unknown</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">units</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Setting cube units to &quot;</span><span class="si">{}</span><span class="s1">&quot; (was &quot;</span><span class="si">{}</span><span class="s1">&quot;)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">units</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_coord_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_coords</span><span class="p">:</span>
            <span class="c1"># Ensure longitude range is between -180 and 180.</span>
            <span class="k">if</span> <span class="n">axis_direction</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">Longitudes</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">within_range</span><span class="p">()</span>

            <span class="c1"># Ensure latitude range is between -90 and 90.</span>
            <span class="k">if</span> <span class="n">axis_direction</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                <span class="n">latitude_points</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">validate_latitudes</span><span class="p">(</span><span class="n">latitude_points</span><span class="p">)</span>

            <span class="c1"># Ensure points for vertical or unnamed coordinates have values equal to those required by the &#39;MIP&#39;.</span>
            <span class="k">if</span> <span class="n">axis_direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">axis_direction</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;T-&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_points</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_coord_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">coord</span><span class="o">.</span><span class="n">has_bounds</span><span class="p">():</span>
                <span class="c1"># Attempt to determine the bounds if they are required by the &#39;MIP&#39;.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mip_metadata</span><span class="o">.</span><span class="n">must_have_bounds</span><span class="p">(</span><span class="n">axis_direction</span><span class="p">):</span>
                    <span class="c1"># ambigious for scalar time coordinate so will be skipped</span>
                    <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">==</span> <span class="s1">&#39;forecast_reference_time&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_bounds</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mip_table_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">,</span> <span class="n">value_type</span><span class="p">):</span>
        <span class="n">mip_metadata_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mip_metadata</span><span class="p">,</span> <span class="n">value_type</span><span class="p">)</span>
        <span class="n">mip_table_values</span> <span class="o">=</span> <span class="n">mip_metadata_method</span><span class="p">(</span><span class="n">axis_direction</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mip_table_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Using the </span><span class="si">{}</span><span class="s1"> specified in the MIP table for &quot;</span><span class="si">{}</span><span class="s1">&quot;: </span><span class="si">{}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value_type</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">mip_table_values</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mip_table_values</span>

    <span class="k">def</span> <span class="nf">_update_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">):</span>
        <span class="c1"># If coord.points are level numbers (positive integers) when they should be level values, use</span>
        <span class="c1"># the points in the &#39;MIP table&#39;.</span>
        <span class="n">should_be_level_values</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;model_level_number&#39;</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))))</span>
        <span class="n">integers</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">should_be_level_values</span> <span class="ow">and</span> <span class="n">positive</span> <span class="ow">and</span> <span class="n">integers</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mip_table_values</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">)</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mip_table_values</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">):</span>
        <span class="n">mip_table_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mip_table_values</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">,</span> <span class="s1">&#39;bounds&#39;</span><span class="p">)</span>
        <span class="c1"># If there are predefined bounds available, use them.</span>
        <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="ow">in</span> <span class="n">PREDEFINED_BOUNDS</span><span class="p">:</span>
            <span class="n">coord</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PREDEFINED_BOUNDS</span><span class="p">[</span><span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">()])</span>

        <span class="c1"># If the bounds are available in the &#39;MIP table&#39;, use them.</span>
        <span class="k">elif</span> <span class="n">mip_table_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Ensure the bounds from the MIP table have the same units as the points from the coordinate.</span>
            <span class="n">mip_table_units</span> <span class="o">=</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mip_table_values</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">))</span>
            <span class="n">coord</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">mip_table_units</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mip_table_bounds</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># Otherwise try to guess the bounds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;there is only one coordinate value&#39;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;the coordinate values are not a numeric data type&#39;</span>
            <span class="k">elif</span> <span class="n">coord</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;the coordinate is not 1D&#39;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">coord</span><span class="o">.</span><span class="n">is_monotonic</span><span class="p">():</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;the coordinate values are non-monotonic&#39;</span>
            <span class="k">elif</span> <span class="n">iris</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_regular</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="ow">or</span> <span class="n">axis_direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">):</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">coord</span><span class="o">.</span><span class="n">guess_bounds</span><span class="p">()</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">axis_direction</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                    <span class="n">bounds</span><span class="p">[</span><span class="n">bounds</span> <span class="o">&gt;</span> <span class="mf">90.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>
                    <span class="n">bounds</span><span class="p">[</span><span class="n">bounds</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">90.</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">90.</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">promote_types</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_data_type</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_data_type</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Guessing bounds for coordinate &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;the coordinate values are not regularly spaced&#39;</span>

            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;The MIP requires that bounds exist for the axis &quot;</span><span class="si">{}</span><span class="s1">&quot;, but unable to guess bounds as </span><span class="si">{}</span><span class="s1">&#39;</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">reason</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_convert_data_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">data_type</span><span class="p">):</span>
        <span class="c1"># Convert the data type of &#39;array&#39; to &#39;data_type&#39; if &#39;array&#39;</span>
        <span class="c1"># does not have the data type &#39;data_type&#39;.</span>
        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">data_type</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array</span>

    <span class="k">def</span> <span class="nf">_match_cube_coords_with_mip_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the coordinates in the cube that correspond to the</span>
<span class="sd">        axes of the dimensions for the |MIP requested variable| as</span>
<span class="sd">        specified in the |MIP table| in the form</span>
<span class="sd">        ``[(coord, axis_direction)]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span><span class="p">:</span>
            <span class="c1"># Determine the axis directions for all the coordinates in</span>
            <span class="c1"># the cube.</span>
            <span class="n">matched_cube_coords</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_cube_coords</span> <span class="o">=</span> <span class="p">{(</span><span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">guess_coord_axis</span><span class="p">(</span><span class="n">coord</span><span class="p">)):</span> <span class="n">coord</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">()}</span>

            <span class="n">cube_axis_directions</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis_direction</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_cube_coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;All cube coordinates: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_cube_coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

            <span class="k">for</span> <span class="n">mip_axis_direction</span><span class="p">,</span> <span class="n">mip_axis_name</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mip_axes_directions_names</span><span class="o">.</span><span class="n">items</span><span class="p">()))):</span>
                <span class="n">matched_axis_direction</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">matching_coord_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">forecast_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mip_metadata</span><span class="o">.</span><span class="n">_get_axis_attribute_value</span><span class="p">(</span><span class="n">mip_axis_name</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">forecast_coord</span> <span class="o">==</span> <span class="s1">&#39;leadtime&#39;</span><span class="p">:</span>
                    <span class="c1"># skipping the leadtime as this will be inserted later</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">mip_axis_direction</span> <span class="ow">in</span> <span class="n">cube_axis_directions</span> <span class="ow">or</span> <span class="p">(</span><span class="n">forecast_coord</span> <span class="ow">and</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">cube_axis_directions</span><span class="p">):</span>
                    <span class="c1"># Use the axis directions to determine whether a coordinate in the cube matches with an axes from</span>
                    <span class="c1"># the &#39;MIP table&#39;.</span>
                    <span class="p">(</span><span class="n">matched_axis_direction</span><span class="p">,</span> <span class="n">matching_coord_name</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_match_axis_directions</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_cube_coords</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">mip_axis_direction</span><span class="p">,</span> <span class="n">mip_axis_name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">cube_axis_direction</span> <span class="o">=</span> <span class="n">matched_axis_direction</span>
                <span class="k">elif</span> <span class="n">mip_axis_direction</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis_name_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="c1"># Use the pre-defined coordinate name if the axis in the &#39;MIP table&#39; does not have an axis</span>
                    <span class="c1"># direction of &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39; or &#39;T&#39;.</span>
                    <span class="n">matched_axis_direction</span> <span class="o">=</span> <span class="n">mip_axis_direction</span>
                    <span class="n">matching_coord_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis_name_mapping</span><span class="p">[</span><span class="n">mip_axis_direction</span><span class="p">]</span>

                    <span class="c1"># For certain axes (effective radius) we need to override the axis direction</span>
                    <span class="c1"># as the PP source data represents this as height (according to iris)</span>
                    <span class="n">cube_axis_direction</span> <span class="o">=</span> <span class="n">OVERRIDE_AXIS_DIRECTION</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">matched_axis_direction</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">matched_axis_direction</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">matching_coord_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cube missing coordinate &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mip_axis_name</span><span class="p">))</span>

                <span class="n">matched_cube_coords</span><span class="p">[</span><span class="n">matched_axis_direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">matching_coord_name</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">all_cube_coords</span><span class="p">[(</span><span class="n">matching_coord_name</span><span class="p">,</span> <span class="n">cube_axis_direction</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coord</span><span class="p">,</span> <span class="n">matched_axis_direction</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Matched coordinates in cube: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matched_cube_coords</span><span class="p">))</span>

            <span class="c1"># Ensure the number of dimensions in the cube matches the number of dimensions specified in</span>
            <span class="c1"># the &#39;MIP table&#39; by removing any dimensions of length one; if the dimension has an associated</span>
            <span class="c1"># dimension or auxiliary coordinate, it is demoted to a scalar coordinate.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matched_coords</span>

    <span class="k">def</span> <span class="nf">_match_axis_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube_coords</span><span class="p">,</span> <span class="n">mip_axis_direction</span><span class="p">,</span> <span class="n">mip_axis_name</span><span class="p">):</span>
        <span class="c1"># the forecast attribute is how we recognise special coordinates for seasonal forecasting</span>
        <span class="n">forecast_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mip_metadata</span><span class="o">.</span><span class="n">_get_axis_attribute_value</span><span class="p">(</span><span class="n">mip_axis_name</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
        <span class="n">matched_axis_direction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">matching_coord_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">initial_matched_coords</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">coord_name</span><span class="p">:</span> <span class="n">cube_axis_direction</span> <span class="k">for</span> <span class="n">coord_name</span><span class="p">,</span> <span class="n">cube_axis_direction</span> <span class="ow">in</span> <span class="n">cube_coords</span>
            <span class="k">if</span> <span class="n">cube_axis_direction</span> <span class="o">==</span> <span class="n">mip_axis_direction</span> <span class="ow">or</span> <span class="p">(</span><span class="n">forecast_coord</span> <span class="ow">and</span> <span class="n">cube_axis_direction</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Matched </span><span class="si">{}</span><span class="s1"> from cube with </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) from MIP table&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">initial_matched_coords</span><span class="p">,</span> <span class="n">mip_axis_name</span><span class="p">,</span> <span class="n">mip_axis_direction</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_matched_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">matched_axis_direction</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial_matched_coords</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">matching_coord_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial_matched_coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">forecast_coord</span><span class="p">:</span>
                <span class="c1"># Forecaset coordinates are another special case which needs consulting with the &#39;MIP table&#39; metadata</span>
                <span class="c1"># use the standard name</span>
                <span class="n">forecast_coord_standard_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mip_metadata</span><span class="o">.</span><span class="n">_get_axis_attribute_value</span><span class="p">(</span><span class="n">mip_axis_name</span><span class="p">,</span>
                                                                                           <span class="s1">&#39;standard_name&#39;</span><span class="p">)</span>
                <span class="n">matched_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">()</span> <span class="k">if</span>
                                  <span class="n">coord</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">==</span> <span class="n">forecast_coord_standard_name</span><span class="p">]</span>
                <span class="n">matched_axis_direction</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
                <span class="n">matching_coord_name</span> <span class="o">=</span> <span class="n">matched_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Multiple axes in the cube have the same &#39;axis direction&#39; as specified in the &#39;MIP table&#39;;</span>
                <span class="c1"># use the axis in the cube that has the same &#39;axis name&#39; as specified in the &#39;MIP table&#39;,</span>
                <span class="c1"># accounting for the fact that some axis names in the &#39;MIP tables&#39; are numbered.</span>
                <span class="n">matched_coords</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">coord_name</span> <span class="k">for</span> <span class="n">coord_name</span> <span class="ow">in</span> <span class="n">initial_matched_coords</span> <span class="k">if</span> <span class="n">mip_axis_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">coord_name</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cube_axis_direction</span> <span class="o">=</span> <span class="n">initial_matched_coords</span><span class="p">[</span><span class="n">matched_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">cube_axis_direction</span> <span class="o">==</span> <span class="n">mip_axis_direction</span><span class="p">:</span>
                        <span class="n">matched_axis_direction</span> <span class="o">=</span> <span class="n">mip_axis_direction</span>
                        <span class="n">matching_coord_name</span> <span class="o">=</span> <span class="n">matched_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">matched_axis_direction</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">matching_coord_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Either no axis or multiple axes have the same &#39;axis name&#39;, so use the dimension</span>
                <span class="c1"># coordinate as a last resort.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">mip_axis_direction</span><span class="p">,</span> <span class="n">dim_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">iris</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">CoordinateNotFoundError</span><span class="p">:</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">matched_axis_direction</span> <span class="o">=</span> <span class="n">mip_axis_direction</span>
                    <span class="n">matching_coord_name</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">matched_axis_direction</span><span class="p">,</span> <span class="n">matching_coord_name</span>

    <span class="k">def</span> <span class="nf">_update_time_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_coord</span><span class="p">):</span>
            <span class="n">base_date</span> <span class="o">=</span> <span class="n">format_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_date</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="s1">&#39;days since </span><span class="si">{date}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">base_date</span><span class="p">)</span>
            <span class="n">cf_time_unit</span> <span class="o">=</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">time_unit</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_coord</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="n">cf_time_unit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_valid_min_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Replace any values lower than &#39;valid_min&#39; with zero.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">valid_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_data_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the data dimension of the coordinate in the cube.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># &#39;cube.coord_dims&#39; returns a tuple of the data dimensions relevant to the given coordinate.</span>
        <span class="n">data_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_dimensions</span><span class="p">:</span>
            <span class="c1"># Scalar coordinate.</span>
            <span class="n">data_dimension</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data_dimension</span> <span class="o">=</span> <span class="n">data_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">axis_direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]:</span>
            <span class="c1"># Support auxiliary grids.</span>
            <span class="k">if</span> <span class="n">axis_direction</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
                <span class="n">data_dimension</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_dimensions</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axis_direction</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                <span class="n">data_dimension</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_dimensions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Only 1-dimensional axes and 2-dimensional latitude and longitude axes are currently supported&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_dimension</span>

    <span class="k">def</span> <span class="nf">_slice_input_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_time</span><span class="p">):</span>
        <span class="n">input_variables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">time_constraint</span> <span class="o">=</span> <span class="n">_setup_time_constraint</span><span class="p">(</span><span class="n">date_time</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">constraint_name</span><span class="p">,</span> <span class="n">cube</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">time_slice</span> <span class="o">=</span> <span class="n">apply_time_constraint</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">time_constraint</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time_slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">date_time_str</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">date_time</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No data available for &quot;</span><span class="si">{}</span><span class="s1">&quot;; please check run_bounds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date_time_str</span><span class="p">))</span>
            <span class="n">input_variables</span><span class="p">[</span><span class="n">constraint_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_slice</span>

        <span class="k">return</span> <span class="n">input_variables</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_time_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time_coord</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis_direction</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
                <span class="n">time_coord</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="k">return</span> <span class="n">time_coord</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_reftime_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reftime_coord</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis_direction</span> <span class="o">==</span> <span class="s1">&#39;T-reftime&#39;</span><span class="p">:</span>
                <span class="n">reftime_coord</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="k">return</span> <span class="n">reftime_coord</span></div>


<span class="k">def</span> <span class="nf">_update_constraint_in_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">constraint_name</span><span class="p">):</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(?=[^\d]|$)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">constraint_name</span><span class="p">))</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">replacement_string</span> <span class="o">=</span> <span class="s1">&#39;self.input_variables[&quot;</span><span class="si">{}</span><span class="s1">&quot;]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">constraint_name</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">replacement_string</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expression</span>


<span class="k">def</span> <span class="nf">_update_constraints_in_expression</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">constraint_name</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">_update_constraint_in_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">constraint_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expression</span>


<div class="viewcode-block" id="VariableModelToMIPMapping"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableModelToMIPMapping">[docs]</a><span class="k">class</span> <span class="nc">VariableModelToMIPMapping</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store the |model to MIP mapping| for a |MIP requested variable|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">mappings_config</span><span class="p">()</span>

<div class="viewcode-block" id="VariableModelToMIPMapping.__init__"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableModelToMIPMapping.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mip_requested_variable_name</span><span class="p">,</span> <span class="n">model_to_mip_mapping</span><span class="p">,</span> <span class="n">model_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the expression provided by the ``model_to_mip_mapping``</span>
<span class="sd">        parameter and add attributes to this object corresponding to</span>
<span class="sd">        the |input variables| and each constraint to this object.</span>

<span class="sd">        :param mip_requested_variable_name: the</span>
<span class="sd">            |MIP requested variable name|</span>
<span class="sd">        :type mip_requested_variable_name: string</span>
<span class="sd">        :param model_to_mip_mapping: the |model to MIP mapping| for the</span>
<span class="sd">            |MIP requested variable|</span>
<span class="sd">        :type model_to_mip_mapping: dictionary</span>
<span class="sd">        :param model_id: the |model identifier|</span>
<span class="sd">        :type model_id: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mip_requested_variable_name</span> <span class="o">=</span> <span class="n">mip_requested_variable_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span> <span class="o">=</span> <span class="n">model_to_mip_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expression_with_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attributes</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return useful constraint-related information about a specific</span>
<span class="sd">        instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span>
        <span class="k">for</span> <span class="n">loadable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadables</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">loadable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loadable</span><span class="o">.</span><span class="n">info</span><span class="p">))</span>
        <span class="c1"># Include the value of the constant as well as the name.</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">replace_constants</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">other_constants</span><span class="p">(),</span> <span class="n">replacement_string</span><span class="o">=</span><span class="s1">&#39;name_value&#39;</span><span class="p">)</span>
        <span class="c1"># remove lbtim default constraints if they aren&#39;t explicit in the expression.</span>
        <span class="k">for</span> <span class="n">lbtim_constraint</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lbtim_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;lbtim_ib&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">lbtim_constraint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">:</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;, </span><span class="si">{}</span><span class="s1">: \d&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lbtim_constraint</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expression</span>

    <span class="k">def</span> <span class="nf">_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">loadable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadables</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">loadable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">loadable</span><span class="o">.</span><span class="n">constraint</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">replace_constants</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">constants</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_loadables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">consts</span> <span class="o">=</span> <span class="n">constants</span><span class="p">()</span>
        <span class="n">consts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">TIMESTEP</span><span class="p">:</span> <span class="n">TIMESTEP</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">parse_to_loadables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">],</span> <span class="n">consts</span><span class="p">,</span> <span class="n">mappings_config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the options from the |model to MIP mapping| configuration</span>
<span class="sd">        file for the |MIP requested variable| as specified by the</span>
<span class="sd">        ``model_to_mip_mapping`` parameter as attributes to the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">raw_value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_to_mip_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">raw_to_value</span><span class="p">(</span><span class="n">mappings_config</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">raw_value</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="replace_constants"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.replace_constants">[docs]</a><span class="k">def</span> <span class="nf">replace_constants</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">constant_items</span><span class="p">,</span> <span class="n">replacement_string</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression specified by ``expression`` with any strings</span>
<span class="sd">    representing constant names (keys in ``constant_items``) replaced</span>
<span class="sd">    with the constant values (values in ``constant_items``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expression: string</span>
<span class="sd">        The expression, which may contain constant names.</span>
<span class="sd">    constant_items: dictionary</span>
<span class="sd">        The names (string) and values (string) of constants that may</span>
<span class="sd">        appear in the expression.</span>
<span class="sd">    replacement_string: string</span>
<span class="sd">        The format to use for the replacement: choose from ``value`` (to</span>
<span class="sd">        replace the name with the value) or ``name_value`` (to replace</span>
<span class="sd">        the name with the name and the value).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">constant_name</span><span class="p">,</span> <span class="n">constant_value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">constant_items</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b</span><span class="si">{}</span><span class="s1">\b&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">constant_name</span><span class="p">))</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">replacement_string</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span>
                <span class="n">replacement</span> <span class="o">=</span> <span class="n">constant_value</span>
            <span class="k">elif</span> <span class="n">replacement_string</span> <span class="o">==</span> <span class="s1">&#39;name_value&#39;</span><span class="p">:</span>
                <span class="n">replacement</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">constant_name</span><span class="p">,</span> <span class="n">constant_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;replacement_string &quot;</span><span class="si">{}</span><span class="s1">&quot; unsupported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">replacement_string</span><span class="p">))</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expression</span></div>


<div class="viewcode-block" id="VariableMIPMetadata"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableMIPMetadata">[docs]</a><span class="k">class</span> <span class="nc">VariableMIPMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store the values from the |MIP table| related to a</span>
<span class="sd">    |MIP requested variable|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="VariableMIPMetadata.__init__"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableMIPMetadata.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_info</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The dictionaries provided by the ``variable_info`` and</span>
<span class="sd">        ``axis`` parameters contains information about the</span>
<span class="sd">        |MIP requested variable| and the axes from the |MIP table|,</span>
<span class="sd">        respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_info</span> <span class="o">=</span> <span class="n">variable_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis_name_mapping</span> <span class="o">=</span> <span class="n">MIP_to_model_axis_name_mapping</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the names (e.g., ``latitude``, ``longitude``, ``time``,</span>
<span class="sd">        etc.) of the axes of the |MIP requested variable| as specified</span>
<span class="sd">        in the |MIP table|.</span>

<span class="sd">        :return: the names of the axes of the |MIP requested variable|</span>
<span class="sd">                 as specified in the |MIP table|</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_info</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_directions_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the directions (e.g., ``X``, ``Y``, ``T``, ``Z``, etc.)</span>
<span class="sd">        and names of the axes of the |MIP requested variable| as</span>
<span class="sd">        specified in the |MIP table|.</span>

<span class="sd">        The names of the axes are returned in the form</span>
<span class="sd">        ``{axis_direction: axis_name}``.</span>

<span class="sd">        :return: the directions of the axes of the</span>
<span class="sd">                 |MIP requested variable| as specified in the</span>
<span class="sd">                 |MIP table|</span>
<span class="sd">        :rtype: dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Sometimes &#39;self.axes_names&#39; contains a dimension with a name that doesn&#39;t exist as an &#39;axis&#39; in</span>
        <span class="c1"># the &#39;MIP table&#39;. In this case, use the name of the axis that exists in the &#39;MIP table&#39;. The format</span>
        <span class="c1"># of &#39;mip_table_axis_names&#39; is: {dimension from self.axes_names: axis name from &#39;MIP table&#39;}</span>
        <span class="n">mip_table_axis_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;olevel&#39;</span><span class="p">:</span> <span class="s1">&#39;depth_coord&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alevel&#39;</span><span class="p">:</span> <span class="s1">&#39;hybrid_height&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alevhalf&#39;</span><span class="p">:</span> <span class="s1">&#39;hybrid_height_half&#39;</span>
        <span class="p">}</span>
        <span class="n">axes_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_names</span>

        <span class="k">for</span> <span class="n">orig_axis_name</span><span class="p">,</span> <span class="n">mip_table_axis_name</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mip_table_axis_names</span><span class="o">.</span><span class="n">items</span><span class="p">()))):</span>
            <span class="k">if</span> <span class="n">orig_axis_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_names</span><span class="p">:</span>
                <span class="n">axes_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis_name</span> <span class="k">for</span> <span class="n">axis_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_names</span> <span class="k">if</span> <span class="n">axis_name</span> <span class="o">!=</span> <span class="n">orig_axis_name</span><span class="p">]</span>
                <span class="n">axes_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mip_table_axis_name</span><span class="p">)</span>

        <span class="c1"># Determine the axis direction for the axis.</span>
        <span class="n">all_axes_directions_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">axis_name</span> <span class="ow">in</span> <span class="n">axes_names</span><span class="p">:</span>
            <span class="c1"># Use the value of the &#39;axis&#39; attribute associated with the  axis from the &#39;MIP table&#39; as</span>
            <span class="c1"># the axis direction, if it exists.</span>
            <span class="n">axis_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_axis_attribute_value</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axis_direction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If there is a coordinate in the cube corresponding to the axis from the &#39;MIP table&#39;,</span>
                <span class="c1"># use the name of the axis as the axis direction (it will be used later by &#39;Variable.</span>
                <span class="c1"># match_cube_coords_with_mip_axes&#39;).</span>
                <span class="k">if</span> <span class="n">axis_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis_name_mapping</span><span class="p">:</span>
                    <span class="n">axis_direction</span> <span class="o">=</span> <span class="n">axis_name</span>
                <span class="c1"># If a pre-defined scalar value, specified by the &#39;value&#39; attribute associated with the axis from</span>
                <span class="c1"># the &#39;MIP table&#39;, exists, there is no need to determine the axis direction here; CMOR will handle</span>
                <span class="c1"># this axis later.</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_axis_attribute_value</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">support_website</span> <span class="o">=</span> <span class="s1">&#39;https://code.metoffice.gov.uk/doc/cdds/mip_convert/support.html&#39;</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Unsupported axis &quot;</span><span class="si">{}</span><span class="s1">&quot;. Please contact the MIP Convert core developers (see </span><span class="si">{}</span><span class="s1">)&#39;</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="n">support_website</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">axis_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># because of underlying assumption that there&#39;s always one coordinate for a given axis</span>
                <span class="c1"># for seasonal forecasting datasets we need to create dummy T axes which are named differently</span>
                <span class="c1"># and associate them with reftime and leadtime coordinates</span>
                <span class="c1"># this way mip convert won&#39;t be confused about multiple time coordiates</span>
                <span class="n">forecast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_axis_attribute_value</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
                <span class="n">axis_name_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis_direction</span><span class="p">,</span> <span class="n">forecast</span><span class="p">)</span> <span class="k">if</span> <span class="n">forecast</span> <span class="k">else</span> <span class="n">axis_direction</span>
                <span class="n">all_axes_directions_names</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">axis_name_key</span><span class="p">:</span> <span class="n">axis_name</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">all_axes_directions_names</span>

    <span class="k">def</span> <span class="nf">_get_axis_attribute_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_name</span><span class="p">,</span> <span class="n">axis_attribute</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">axis_attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_name</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_name</span><span class="p">][</span><span class="n">axis_attribute</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_name</span><span class="p">][</span><span class="n">axis_attribute</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="VariableMIPMetadata.must_have_bounds"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableMIPMetadata.must_have_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">must_have_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether the axis must have bounds as specified in the</span>
<span class="sd">        |MIP table|.</span>

<span class="sd">        :param axis_direction: the direction (e.g., ``X``, ``Y``,</span>
<span class="sd">            ``T``, ``Z``, etc.) of the axis</span>
<span class="sd">        :type axis_direction: string</span>
<span class="sd">        :return: whether the axis must have bound as specified in the</span>
<span class="sd">            |MIP table|</span>
<span class="sd">        :rtype: Boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axis_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_directions_names</span><span class="p">[</span><span class="n">axis_direction</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_name</span><span class="p">][</span><span class="s1">&#39;must_have_bounds&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="n">have_bounds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">bounds</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="n">have_bounds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">have_bounds</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="k">return</span> <span class="n">have_bounds</span></div>

<div class="viewcode-block" id="VariableMIPMetadata.points"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableMIPMetadata.points">[docs]</a>    <span class="k">def</span> <span class="nf">points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the points for the axis as specified in the |MIP table|.</span>

<span class="sd">        :param axis_direction: the direction (e.g., ``X``, ``Y``,</span>
<span class="sd">            ``T``, ``Z``, etc.) of the axis</span>
<span class="sd">        :type axis_direction: string</span>
<span class="sd">        :return: the points for the axis as specified in the</span>
<span class="sd">            |MIP table|</span>
<span class="sd">        :rtype: :func:`numpy.array`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attribute_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;requested&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_values</span><span class="p">(</span><span class="n">axis_direction</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">)</span></div>

<div class="viewcode-block" id="VariableMIPMetadata.bounds"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableMIPMetadata.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the bounds for the axis as specified in the |MIP table|.</span>

<span class="sd">        :param axis_direction: the direction (e.g., ``X``, ``Y``,</span>
<span class="sd">            ``T``, ``Z``, etc.) of the axis</span>
<span class="sd">        :type axis_direction: string</span>
<span class="sd">        :return: the bounds for the axis as specified in the</span>
<span class="sd">            |MIP table|</span>
<span class="sd">        :rtype: :func:`numpy.array`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attribute_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;requested_bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;bounds_values&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_values</span><span class="p">(</span><span class="n">axis_direction</span><span class="p">,</span> <span class="s1">&#39;bounds&#39;</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">)</span></div>

<div class="viewcode-block" id="VariableMIPMetadata.units"><a class="viewcode-back" href="../../mip_convert/new_variable.html#mip_convert.new_variable.VariableMIPMetadata.units">[docs]</a>    <span class="k">def</span> <span class="nf">units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the units for the axis as specified in the |MIP table|.</span>

<span class="sd">        :param axis_direction: the direction (e.g., ``X``, ``Y``,</span>
<span class="sd">            ``T``, ``Z``, etc.) of the axis</span>
<span class="sd">        :type axis_direction: string</span>
<span class="sd">        :return: the units for the axis as specified in the</span>
<span class="sd">            |MIP table|</span>
<span class="sd">        :rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axis_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_directions_names</span><span class="p">[</span><span class="n">axis_direction</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw_value</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_direction</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">):</span>
        <span class="n">axis_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_directions_names</span><span class="p">[</span><span class="n">axis_direction</span><span class="p">]</span>
        <span class="n">all_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attribute_name</span> <span class="ow">in</span> <span class="n">attribute_names</span><span class="p">:</span>
            <span class="n">raw_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw_value</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raw_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">formatted_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_raw_value</span><span class="p">(</span><span class="n">raw_value</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">formatted_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">all_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_values</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">all_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">all_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">all_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Multiple values determined from MIP table for &quot;</span><span class="si">{}</span><span class="s1">&quot;: </span><span class="si">{}</span><span class="s1"> != </span><span class="si">{}</span><span class="s1">&#39;</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="n">all_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">all_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">all_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">_get_raw_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_name</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">attribute_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_name</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_name</span><span class="p">][</span><span class="n">attribute_name</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_name</span><span class="p">][</span><span class="n">attribute_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_format_raw_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_value</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">):</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">raw_value</span> <span class="o">=</span> <span class="n">raw_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separators</span><span class="p">[</span><span class="n">value_type</span><span class="p">])</span>

        <span class="n">formatted_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">raw_value</span><span class="p">])</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="s1">&#39;_mip_table_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">formatted_value</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">formatted_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">formatted_value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_mip_table_bounds_values</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">bounds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_mip_table_requested_bounds</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bounds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_setup_time_constraint</span><span class="p">(</span><span class="n">date_time</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">time_constraint</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">PartialDateTime</span><span class="p">(</span><span class="o">*</span><span class="n">date_time</span><span class="p">)</span> <span class="o">==</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span> <span class="ow">or</span>
                <span class="n">PartialDateTime</span><span class="p">(</span><span class="n">date_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">time_constraint</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MIP Convert 2.3.3.dev0+main.2f65f7c-M documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">mip_convert.new_variable</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright British Crown 2015-2021, Met Office.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>